<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SpoMini ‚Äî G√º√ßl√º Mini Player</title>
<style>
/* -------------------------
   TEMEL STƒ∞LLER & LAYOUT
   ------------------------- */
:root{
  --bg1:#04040a; --bg2:#080026;
  --panel: rgba(255,255,255,0.03);
  --accent1:#7b2cff; --accent2:#00c2ff;
  --muted: rgba(255,255,255,0.6);
}
*{box-sizing:border-box;font-family:Inter, "Poppins", system-ui, Arial, sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(120deg,var(--bg1),var(--bg2));
         background-size:400% 400%; animation: bgAnim 18s linear infinite; color:#fff}
@keyframes bgAnim{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.app{display:flex;height:100vh;gap:12px;align-items:stretch}

/* -------------------------
   SIDEBAR (QUEUE)
   ------------------------- */
.sidebar{
  width:72px;background:var(--panel);backdrop-filter:blur(8px);
  display:flex;flex-direction:column;align-items:center;padding:14px 8px;transition:width .28s;
  position:relative;
}
.sidebar.open{width:320px}
.menu-toggle{background:none;border:none;color:var(--muted);font-size:20px;cursor:pointer;margin-bottom:6px}
.menu-toggle:hover{color:#fff}
.queue-area{display:none;flex-direction:column;align-items:center;width:100%;height:100%}
.sidebar.open .queue-area{display:flex}
.queue-input{
  width:88%;padding:10px;border-radius:10px;border:none;margin:8px 0;background:rgba(255,255,255,0.03);
  color:#fff;text-align:left; outline:none;
}
.queue-add-btn{width:88%;padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent1),#6fe0ff);
  color:#000;font-weight:700;cursor:pointer}
.queue-list{width:94%;margin-top:10px;overflow:auto;flex:1;padding-bottom:12px}
.queue-item{
  display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;margin:8px 0;background:rgba(255,255,255,0.02);
  cursor:grab; user-select:none;
}
.queue-item.dragging{opacity:0.4}
.queue-thumb{width:56px;height:40px;object-fit:cover;border-radius:6px;flex-shrink:0}
.queue-info{display:flex;flex-direction:column;flex:1;min-width:0}
.queue-title{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.queue-sub{font-size:11px;color:var(--muted);margin-top:4px}
.item-controls{display:flex;gap:6px;align-items:center}
.icon-btn{background:none;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:6px}
.icon-btn:hover{color:#fff;background:rgba(255,255,255,0.02)}

/* popup menu */
.item-menu{position:relative}
.menu-body{position:absolute;right:8px;top:34px;background:rgba(0,0,0,0.6);border-radius:8px;padding:6px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:flex;flex-direction:column}
.menu-body button{border:none;background:none;color:#fff;padding:8px 12px;text-align:left;cursor:pointer;border-radius:6px}
.menu-body button:hover{background:rgba(255,255,255,0.03)}

/* -------------------------
   MAIN PLAY AREA
   ------------------------- */
.main{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;position:relative;padding:20px}
.player-card{display:flex;flex-direction:column;align-items:center;gap:14px;padding:18px;border-radius:16px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 10px 40px rgba(0,0,0,0.6);
  width: 90%; 
  max-width: 580px; 
}
.disk{
  width:260px;height:260px;border-radius:50%;overflow:hidden;border:6px solid rgba(255,255,255,0.04);
  display:flex;align-items:center;justify-content:center;position:relative;animation:spin 6s linear infinite;
  box-shadow:0 20px 60px rgba(80,0,255,0.12);
}
.disk.empty{background: radial-gradient(circle at 30% 20%, rgba(120,0,255,0.06), transparent 10%), rgba(0,0,0,0.12)}
@keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.disk img.thumb{width:100%;height:100%;object-fit:cover;display:block}
.song-title{font-weight:600;color:#efeaff;font-size:18px;max-width:520px;text-align:center}
.song-sub{font-size:13px;color:var(--muted)}

/* Progress Bar Alanƒ± */
.progress-area{
  width: 100%;
  padding: 0 10px;
  margin-bottom: 8px;
  cursor: pointer; 
}
.progress-container{
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  position: relative;
  overflow: hidden;
}
.progress-bar{
  height: 100%;
  width: 0%; 
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  transition: width 0.1s linear; 
}
.time-info{
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}
.time-current{color:#fff;}


/* controls */
.controls{
  display:flex;gap:12px;align-items:center;
  padding: 10px 0;
}
.ctrl-btn{background:linear-gradient(135deg,var(--accent1),var(--accent2));border:none;color:#fff;padding:10px 16px;border-radius:12px;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
.ctrl-small{padding:8px 12px;border-radius:10px}

/* yeni eklenen loop/shuffle stilleri */
.loop-shuffle-controls{
  display:flex;gap:12px;align-items:center;margin-top:10px;
}
.loop-select{
  padding:8px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.05);
  color:#fff;cursor:pointer;outline:none;
}
.shuffle-btn{
  padding:8px 12px;border-radius:10px;border:none;background:rgba(255,255,255,0.05);
  color:#fff;cursor:pointer;outline:none;
}
.shuffle-btn.active{
  background:var(--accent1);
}

/* volume column on right */
.vol-col{position:absolute;right:18px;bottom:18%;display:flex;flex-direction:column;gap:12px;align-items:center}
.vol-btn{width:48px;height:48px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--accent1),#7a32ff);color:#fff;font-size:18px;cursor:pointer;box-shadow:0 8px 25px rgba(0,0,0,0.5)}
.vol-level{writing-mode:vertical-rl;transform:rotate(180deg);font-size:12px;color:var(--muted);margin-top:6px}

/* responsive tweaks */
@media (max-width:900px){
  .sidebar{display:none}
  .vol-col{right:8px;bottom:8%}
  .song-title{font-size:16px}
}
</style>
</head>
<body onload="loadState()"> <div class="app">
    <div class="sidebar" id="sidebar">
      <button class="menu-toggle" id="menuBtn" title="Queue a√ß/kapa">‚ò∞</button>

      <div class="queue-area" id="queueArea">
        <input id="queueInput" class="queue-input" placeholder="YouTube linki yapƒ±≈ütƒ±r veya ID (√∂r: xVjLar3I5hM)" />
        <button class="queue-add-btn" id="addBtn">‚ûï Sƒ±raya Ekle</button>
        <div class="queue-list" id="queueList" aria-live="polite"></div>
      </div>
    </div>

    <div class="main">
      <div class="player-card" id="playerCard">
        <div class="disk empty" id="disk" title="Disk (kapak burada g√∂sterilir)"></div>

        <div style="text-align:center; width:100%;">
          <div class="song-title" id="songTitle">Sƒ±rada ≈üarkƒ± yok</div>
          <div class="song-sub" id="songSub">Sƒ±raya ≈üarkƒ± ekle ve Oynat'a bas</div>
        </div>
        
        <div class="progress-area" id="progressArea">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="time-info">
                <span class="time-current" id="timeCurrent">0:00</span>
                <span class="time-duration" id="timeDuration">0:00</span>
            </div>
        </div>

        <div class="controls">
          <button class="ctrl-btn ctrl-small" id="prevBtn">‚èÆÔ∏è Atla</button>
          <button class="ctrl-btn ctrl-small" id="rew10">‚è™ 10s</button>
          <button class="ctrl-btn" id="playBtn">‚ñ∂Ô∏è Oynat</button>
          <button class="ctrl-btn ctrl-small" id="fwd10">10s ‚è©</button>
          <button class="ctrl-btn ctrl-small" id="nextBtn">Atla ‚è≠Ô∏è</button>
        </div>
        
        <div class="loop-shuffle-controls">
          <select id="loopSelect" class="loop-select" title="D√∂ng√º Modu">
            <option value="none">D√∂ng√º Yok</option>
            <option value="single">üîÅ Tekrar (≈ûarkƒ±)</option>
            <option value="queue">üîÑ D√∂ng√º (Sƒ±ra)</option>
          </select>
          <button class="shuffle-btn" id="shuffleBtn" title="Sƒ±rayƒ± Karƒ±≈ütƒ±r">üîÄ Karƒ±≈ütƒ±r</button>
        </div>
        
        <div style="margin-top:6px;color:var(--muted);font-size:13px" id="infoLine"></div>
      </div>

      <div id="player" style="display:none"></div>
    </div>

    <div class="vol-col" id="volCol">
      <button class="vol-btn" id="volUp">üîä</button>
      <button class="vol-btn" id="volDown">üîâ</button>
      <div class="vol-level" id="volLabel">100%</div>
    </div>
  </div>

<script>
/* =================================================================================
   SPOTIX ‚Äî Tam Kapsamlƒ± Player
   - YENƒ∞: Kalƒ±cƒ± Sƒ±ra ve Ayarlar (Local Storage)
   ================================================================================= */

/* ---------- Global state ---------- */
let player = null;
let isPlaying = false;
let queue = []; // { id, title, thumbnail, originalUrl }
let currentIndex = -1;
let volume = 100;
let loopMode = 'none'; // 'none', 'single', 'queue'
let isShuffle = false;
let shuffleHistory = []; 
let progressInterval = null; 

/* ---------- Local Storage Management (YENƒ∞) ---------- */
const STORAGE_KEY = 'spoMiniPlayerState';

function saveState() {
    try {
        const state = {
            queue: queue,
            currentIndex: currentIndex,
            volume: volume,
            loopMode: loopMode,
            isShuffle: isShuffle,
            // isPlaying'i kaydetmiyoruz, √ß√ºnk√º tarayƒ±cƒ± kapandƒ±ƒüƒ±nda oynatma durumu sƒ±fƒ±rlanmalƒ±dƒ±r.
            // shuffleHistory'yi kaydetmiyoruz, √ß√ºnk√º sƒ±ra deƒüi≈üebilir.
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch(e) {
        console.error("Local Storage'a kaydedilirken hata olu≈ütu", e);
    }
}

function loadState() {
    try {
        const storedState = localStorage.getItem(STORAGE_KEY);
        if (storedState) {
            const state = JSON.parse(storedState);
            
            // Verileri geri y√ºkle
            queue = state.queue || [];
            // Eƒüer kaydedilmi≈ü queue'da bir problem varsa (√∂rneƒüin null), currentIndex'i -1 yap.
            currentIndex = (queue.length > 0 && state.currentIndex >= 0 && state.currentIndex < queue.length) 
                ? state.currentIndex 
                : -1;
                
            volume = state.volume !== undefined ? Math.max(0, Math.min(100, state.volume)) : 100;
            loopMode = state.loopMode || 'none';
            isShuffle = state.isShuffle || false;

            // UI'ƒ± g√ºncelle
            updateQueueUI();
            updateVolumeUI();
            loopSelect.value = loopMode;
            shuffleBtn.classList.toggle('active', isShuffle);
            shuffleBtn.innerText = isShuffle ? 'üîÄ Karƒ±≈ütƒ±r (A√ßƒ±k)' : 'üîÄ Karƒ±≈ütƒ±r';

            // Eƒüer sƒ±rada bir ≈üarkƒ± varsa, ba≈ülƒ±k bilgisini y√ºkle
            if (currentIndex !== -1) {
                const currentTrack = queue[currentIndex];
                songTitle.innerText = currentTrack.title || ('Video ' + (currentIndex + 1));
                songSub.innerText = 'Sƒ±radaki: ' + (currentIndex + 1) + ' / ' + queue.length;
                infoLine.innerText = 'Durum y√ºklendi. Oynat\'a basarak devam et.';
                // Disk kapaƒüƒ±nƒ± g√∂ster
                renderDiskThumb(); 
            } else {
                stopAndClear();
            }
        } else {
            // ƒ∞lk a√ßƒ±lƒ±≈üta veya kayƒ±t yoksa default olarak temizle
            stopAndClear();
        }
    } catch(e) {
        console.error("Local Storage'dan y√ºklenirken hata olu≈ütu", e);
        stopAndClear(); // Hata olursa temiz ba≈ülasƒ±n
    }
    // Startup Alert'ƒ± sadece y√ºkleme bittikten sonra g√∂ster
    showStartupAlert();
}

/* ---------- Helper: Time formatting (seconds to MM:SS) ---------- */
function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return '0:00';
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

/* ---------- Helper: robust parse for many YouTube URL variants ---------- */
function extractVideoId(raw) {
  if(!raw) return null;
  raw = raw.trim();

  if(/^[A-Za-z0-9_-]{11}$/u.test(raw)) return raw;

  try {
    const u = new URL(raw.startsWith('http') ? raw : ('https://' + raw));
    if(u.searchParams.has('v')) { return u.searchParams.get('v'); }
    const parts = u.pathname.split('/').filter(Boolean);
    for(let p of parts) { if(/^[A-Za-z0-9_-]{11}$/u.test(p)) return p; }
    if(u.hostname && (u.hostname.includes('youtu.be') || u.hostname.includes('youtube.com'))) {
      const m = raw.match(/(?:v=|\/)([A-Za-z0-9_-]{11})/u);
      return m ? m[1] : null;
    }
  } catch(e){
    const m = raw.match(/([A-Za-z0-9_-]{11})/u);
    return m ? m[1] : null;
  }
  const m = raw.match(/(?:v=|\/)([A-Za-z0-9_-]{11})/u);
  return m ? m[1] : null;
}

/* ---------- oEmbed fetch for title + thumbnail (no API key) ---------- */
async function fetchVideoInfo(videoUrlOrId) {
  const testUrl = videoUrlOrId.startsWith('http') ? videoUrlOrId : ('https://www.youtube.com/watch?v=' + videoUrlOrId);
  const endpoint = 'https://noembed.com/embed?url=' + encodeURIComponent(testUrl);
  try {
    const res = await fetch(endpoint);
    if(!res.ok) throw new Error('oembed fail');
    const j = await res.json();
    return {
      title: j.title || null,
      thumbnail: j.thumbnail_url || null
    };
  } catch(err){
    const id = extractVideoId(videoUrlOrId);
    return { title: null, thumbnail: id ? `https://img.youtube.com/vi/${id}/hqdefault.jpg` : null };
  }
}

/* ---------- UI references ---------- */
const menuBtn = document.getElementById('menuBtn');
const sidebar = document.getElementById('sidebar');
const queueArea = document.getElementById('queueArea');
const queueInput = document.getElementById('queueInput');
const addBtn = document.getElementById('addBtn');
const queueList = document.getElementById('queueList');
const disk = document.getElementById('disk');
const songTitle = document.getElementById('songTitle');
const songSub = document.getElementById('songSub');
const playBtn = document.getElementById('playBtn');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const rewBtn = document.getElementById('rew10');
const fwdBtn = document.getElementById('fwd10');
const volUpBtn = document.getElementById('volUp');
const volDownBtn = document.getElementById('volDown');
const volLabel = document.getElementById('volLabel');
const infoLine = document.getElementById('infoLine');
const loopSelect = document.getElementById('loopSelect');
const shuffleBtn = document.getElementById('shuffleBtn');
const progressArea = document.getElementById('progressArea');
const progressBar = document.getElementById('progressBar');
const timeCurrent = document.getElementById('timeCurrent');
const timeDuration = document.getElementById('timeDuration');

/* ---------- Startup Alert: PC only + Rules ---------- */
function showStartupAlert(){
  const rules = `
  ‚ö†Ô∏è Dƒ∞KKAT: YALNIZCA Bƒ∞LGƒ∞SAYAR (Masa√ºst√º) KULLANIMI ƒ∞√áƒ∞N TASARLANMI≈ûTIR.

  ... (Kurallar buraya kopyalanƒ±r) ...

  `;
  if(!localStorage.getItem('spoMiniAlertShown')) {
    alert(rules);
    localStorage.setItem('spoMiniAlertShown', 'true');
  }
}
// loadState() i√ßinde √ßaƒürƒ±lacak: showStartupAlert();

/* ---------- Toggle sidebar ---------- */
menuBtn.addEventListener('click', ()=> sidebar.classList.toggle('open'));

/* ---------- YouTube IFrame API bootstrap ---------- */
(function loadYT(){
  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(tag);
})();

function onYouTubeIframeAPIReady(){
  player = new YT.Player('player', {
    height: '0', width: '0', videoId: '',
    playerVars: {
      playsinline: 1,
      controls: 0,
      modestbranding: 1,
      rel: 0,
      showinfo: 0
    },
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange,
      onError: onPlayerError
    }
  });
}

function onPlayerReady(ev){
  try { player.setVolume(volume); } catch(e){}
  updateVolumeUI();
  if (progressInterval) clearInterval(progressInterval);
  progressInterval = setInterval(updateProgress, 1000);
  
  // Eƒüer kaydedilmi≈ü bir ≈üarkƒ± varsa, y√ºkle (ancak autoplay yapma)
  if (currentIndex !== -1) {
    const currentTrack = queue[currentIndex];
    // Sadece y√ºkle, play yapma
    player.cueVideoById(currentTrack.id);
  }
}

/* ---------- Player events ---------- */
function onPlayerStateChange(ev){
  const S = YT.PlayerState;
  if(ev.data === S.ENDED){
    handlePlaybackEnd();
  } else if(ev.data === S.PLAYING){
    isPlaying = true;
    playBtn.innerText = '‚è∏Ô∏è Duraklat';
    infoLine.innerText = '√áalƒ±yor: ' + (currentIndex + 1) + ' / ' + queue.length;
    updateProgress(); 
    renderDiskThumb();
  } else if(ev.data === S.PAUSED || ev.data === S.UNSTARTED){
    isPlaying = false;
    playBtn.innerText = '‚ñ∂Ô∏è Oynat';
  } else if(ev.data === S.BUFFERING){
    infoLine.innerText = 'Buffering...';
    setTimeout(()=>{ try{ player.playVideo(); }catch(e){} }, 600);
  }
}

function onPlayerError(ev){
  console.warn('YT Player Error', ev);
  setTimeout(()=>{ playNext(); }, 700);
}

/* ---------- Progress Bar Logic ---------- */
function updateProgress() {
    if (!player || !player.getCurrentTime || !player.getDuration) return;
    try {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();

        if (duration > 0 && currentTime >= 0) {
            const progress = (currentTime / duration) * 100;
            progressBar.style.width = progress + '%';
            timeCurrent.innerText = formatTime(currentTime);
            if (timeDuration.innerText === '0:00' && duration > 0) {
                timeDuration.innerText = formatTime(duration);
            }
        } else {
            progressBar.style.width = '0%';
            timeCurrent.innerText = '0:00';
            if (currentIndex !== -1) {
                timeDuration.innerText = 'Y√ºkleniyor...';
            } else {
                timeDuration.innerText = '0:00';
            }
        }
    } catch(e) {}
}

function setProgress(e) {
    if (!player || !player.getDuration || currentIndex === -1) {
        alert("L√ºtfen √∂nce sƒ±raya bir ≈üarkƒ± ekleyin ve oynatƒ±n.");
        return;
    }
    
    const rect = progressArea.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const width = rect.width;
    const seekPercentage = clickX / width;
    const duration = player.getDuration();
    if (duration <= 0) return;
    const seekToTime = duration * seekPercentage;
    
    try {
        player.seekTo(seekToTime, true);
    } catch(err) {}
}


/* ---------- Queue operations ---------- */

async function addToQueue(){
  const raw = (queueInput.value || '').trim();
  if(!raw){ alert('Bir YouTube linki veya ID gir.'); return; }
  const id = extractVideoId(raw);
  if(!id){ alert('Ge√ßerli YouTube linki deƒüil veya ID alƒ±namƒ±yor.'); return; }

  const orig = raw;
  const index = queue.length;
  queue.push({ id, title: 'Y√ºkleniyor...', thumbnail: null, originalUrl: orig });
  updateQueueUI();
  queueInput.value = '';
  const info = await fetchVideoInfo(orig);
  queue[index].title = info.title || ('Video ' + (index+1));
  queue[index].thumbnail = info.thumbnail || `https://img.youtube.com/vi/${id}/hqdefault.jpg`;
  updateQueueUI();
  
  if(queue.length === 1){
    currentIndex = 0;
    loadAndPlayIndex(0);
  }
  saveState(); // YENƒ∞: Sƒ±raya eklenince kaydet
}

function updateQueueUI(){
  queueList.innerHTML = '';
  queue.forEach((item, i) => {
    // ... (UI elementleri - Deƒüi≈ümedi) ...
    const row = document.createElement('div');
    row.className = 'queue-item';
    row.draggable = true;
    row.dataset.index = i;
    
    const img = document.createElement('img');
    img.className = 'queue-thumb';
    img.src = item.thumbnail || '';
    row.appendChild(img);

    const txt = document.createElement('div');
    txt.className = 'queue-info';
    const t = document.createElement('div');
    t.className = 'queue-title';
    t.innerText = item.title || ('Video ' + (i+1));
    const s = document.createElement('div');
    s.className = 'queue-sub';
    s.innerText = item.id;
    txt.appendChild(t); txt.appendChild(s);
    row.appendChild(txt);

    const controls = document.createElement('div');
    controls.className = 'item-controls';

    const playNow = document.createElement('button');
    playNow.className = 'icon-btn';
    playNow.title = '≈ûimdi √ßal';
    playNow.innerText = '‚ñ∂';
    playNow.addEventListener('click', (ev)=> { ev.stopPropagation(); playFromQueue(i); });

    const upBtn = document.createElement('button');
    upBtn.className = 'icon-btn';
    upBtn.title = 'Yukarƒ± ta≈üƒ±';
    upBtn.innerText = '‚Üë';
    upBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); moveUp(i); });

    const downBtn = document.createElement('button');
    downBtn.className = 'icon-btn';
    downBtn.title = 'A≈üaƒüƒ± ta≈üƒ±';
    downBtn.innerText = '‚Üì';
    downBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); moveDown(i); });

    const delBtn = document.createElement('button');
    delBtn.className = 'icon-btn';
    delBtn.title = 'Sil (onay gerekiyor)';
    delBtn.innerText = 'üóë';
    delBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); confirmRemove(i); });

    controls.appendChild(playNow);
    controls.appendChild(upBtn);
    controls.appendChild(downBtn);
    controls.appendChild(delBtn);

    row.appendChild(controls);
    row.addEventListener('click', ()=>{ playFromQueue(i); });

    row.addEventListener('dragstart', (ev)=>{
      row.classList.add('dragging');
      ev.dataTransfer.effectAllowed = 'move';
      ev.dataTransfer.setData('text/plain', i.toString());
    });
    row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
    row.addEventListener('dragover', (ev)=> ev.preventDefault());
    row.addEventListener('drop', (ev)=>{
      ev.preventDefault();
      const from = parseInt(ev.dataTransfer.getData('text/plain'));
      const to = parseInt(row.dataset.index);
      if(!isNaN(from) && !isNaN(to) && from !== to) {
        reorderQueue(from, to);
      }
    });

    queueList.appendChild(row);
  });
  saveState(); // YENƒ∞: Sƒ±ra UI'ƒ± deƒüi≈üince (drag/drop sonrasƒ±) kaydet
}

function reorderQueue(from, to) {
  if(from === to) return;
  const item = queue.splice(from,1)[0];
  queue.splice(to,0,item);
  if(currentIndex === from) currentIndex = to;
  else if(from < currentIndex && to >= currentIndex) currentIndex--;
  else if(from > currentIndex && to <= currentIndex) currentIndex++;
  updateQueueUI();
  saveState(); // YENƒ∞: Sƒ±ra deƒüi≈üince kaydet
}

function moveUp(i){
  if(i <= 0) return;
  reorderQueue(i, i-1);
}
function moveDown(i){
  if(i >= queue.length-1) return;
  reorderQueue(i, i+1);
}

function confirmRemove(i){
  const item = queue[i];
  const ok = confirm(`'${item.title || item.id}' silinsin mi? (Geri alamazsƒ±n)`);
  if(!ok) return;
  removeFromQueue(i);
}
function removeFromQueue(i){
  const wasCurrent = (i === currentIndex);
  queue.splice(i,1);
  if(queue.length === 0) {
    currentIndex = -1;
    stopAndClear();
  } else {
    if(wasCurrent) {
      const nextIndex = i < queue.length ? i : queue.length-1;
      loadAndPlayIndex(nextIndex);
    } else {
      if(i < currentIndex) currentIndex--;
      updateQueueUI();
    }
  }
  saveState(); // YENƒ∞: Sƒ±radan silinince kaydet
}

/* ---------- Loading & Playback ---------- */
function loadAndPlayIndex(index){
  if(!player) { currentIndex = index; return; }
  if(index < 0 || index >= queue.length) return;
  const id = queue[index].id;
  currentIndex = index;

  if (isShuffle) { shuffleHistory.push(currentIndex); }

  songTitle.innerText = queue[index].title || ('Video ' + (index+1));
  songSub.innerText = 'Sƒ±radaki: ' + (index+1) + ' / ' + queue.length;
  infoLine.innerText = 'Y√ºkleniyor...';
  
  progressBar.style.width = '0%';
  timeCurrent.innerText = '0:00';
  timeDuration.innerText = '0:00';
  
  try {
    player.loadVideoById(id);
    setTimeout(()=>{ try{ player.playVideo(); }catch(e){} }, 500);
  } catch(err) {
    const iframe = document.getElementById('player');
    if(iframe) iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&enablejsapi=1`;
  }
  
  renderDiskThumb();
  updateQueueUI();
  saveState(); // YENƒ∞: Yeni ≈üarkƒ± √ßalmaya ba≈ülayƒ±nca index'i kaydet
}

function playFromQueue(i){
  if(i < 0 || i >= queue.length) return;
  shuffleHistory = [];
  loadAndPlayIndex(i);
  setTimeout(()=>{ try{ player.playVideo(); }catch(e){} }, 400);
}

function handlePlaybackEnd() {
  if (queue.length === 0) { stopAndClear(); return; }
  
  if (loopMode === 'single') {
    loadAndPlayIndex(currentIndex);
    player.seekTo(0, true);
    player.playVideo();
    return;
  }

  playNext(true); 
}


function playNext(fromEnd = false){
  if(queue.length === 0) { stopAndClear(); return; }
  
  let nextIndex;
  
  if (isShuffle) {
    const availableIndices = queue.map((_, i) => i).filter(i => i !== currentIndex);
    if (availableIndices.length === 0) {
      nextIndex = -1;
    } else {
      const randomIndex = Math.floor(Math.random() * availableIndices.length);
      nextIndex = availableIndices[randomIndex];
    }
  } else {
    nextIndex = currentIndex + 1;
  }

  if(nextIndex < queue.length && nextIndex !== -1) {
    loadAndPlayIndex(nextIndex);
  } else {
    if(loopMode === 'queue') {
      loadAndPlayIndex(0);
    } else {
      isPlaying = false;
      playBtn.innerText = '‚ñ∂Ô∏è Oynat';
      infoLine.innerText = 'Sƒ±ranƒ±n sonu';
      stopPlayback(); 
    }
  }
}

function playPrev(){
  if(queue.length === 0) return;
  
  let prevIndex;
  
  if (isShuffle) {
    if (shuffleHistory.length > 1) {
      shuffleHistory.pop();
      prevIndex = shuffleHistory.pop();
    } else {
      prevIndex = currentIndex;
    }
  } else {
    prevIndex = currentIndex - 1;
  }

  if (prevIndex >= 0) {
    loadAndPlayIndex(prevIndex);
  } else {
    loadAndPlayIndex(currentIndex);
  }
}


function stopAndClear(){
  try{ if(player && player.stopVideo) player.stopVideo(); } catch(e){}
  songTitle.innerText = 'Sƒ±rada ≈üarkƒ± yok';
  songSub.innerText = '';
  disk.classList.remove('playing');
  disk.classList.add('empty');
  disk.innerHTML = '';
  infoLine.innerText = '';
  
  progressBar.style.width = '0%';
  timeCurrent.innerText = '0:00';
  timeDuration.innerText = '0:00';
  
  currentIndex = -1; // YENƒ∞: Indexi sƒ±fƒ±rla
  updateQueueUI();
  saveState(); // YENƒ∞: Durum sƒ±fƒ±rlanƒ±nca kaydet
}

function renderDiskThumb(){
  disk.classList.remove('empty');
  disk.innerHTML = '';
  if(currentIndex >= 0 && queue[currentIndex] && queue[currentIndex].thumbnail) {
    const img = document.createElement('img');
    img.className = 'thumb';
    img.src = queue[currentIndex].thumbnail;
    img.alt = queue[currentIndex].title || 'kapak';
    disk.appendChild(img);
    if(isPlaying) disk.style.animationPlayState = 'running';
    else disk.style.animationPlayState = 'paused';
  } else {
    disk.classList.add('empty');
  }
}

/* ---------- Controls: play/pause/stop/seek/volume ---------- */
function togglePlay(){
  if(!player) return alert('Player hen√ºz hazƒ±r deƒüil, biraz bekle.');
  if(isPlaying){
    try{ player.pauseVideo(); } catch(e){}
    isPlaying = false;
    playBtn.innerText = '‚ñ∂Ô∏è Oynat';
    disk.style.animationPlayState = 'paused';
  } else {
    if(currentIndex === -1 && queue.length > 0) {
      loadAndPlayIndex(0);
    }
    try{ player.playVideo(); } catch(e){}
    isPlaying = true;
    playBtn.innerText = '‚è∏Ô∏è Duraklat';
    disk.style.animationPlayState = 'running';
  }
}

function volumeUp(){
  if(!player || !player.setVolume) return;
  volume = Math.min(100, volume + 10);
  try{ player.setVolume(volume); } catch(e){}
  updateVolumeUI();
  saveState(); // YENƒ∞: Ses deƒüi≈üince kaydet
}

function volumeDown(){
  if(!player || !player.setVolume) return;
  volume = Math.max(0, volume - 10);
  try{ player.setVolume(volume); } catch(e){}
  updateVolumeUI();
  saveState(); // YENƒ∞: Ses deƒüi≈üince kaydet
}

function updateVolumeUI(){
  volLabel.innerText = volume + '%';
}

/* ---------- Loop & Shuffle Controls Handlers ---------- */
loopSelect.addEventListener('change', (e) => {
  loopMode = e.target.value;
  infoLine.innerText = `D√∂ng√º Modu: ${e.target.options[e.target.selectedIndex].text}`;
  saveState(); // YENƒ∞: D√∂ng√º modu deƒüi≈üince kaydet
});

shuffleBtn.addEventListener('click', () => {
  isShuffle = !isShuffle;
  shuffleBtn.classList.toggle('active', isShuffle);
  shuffleBtn.innerText = isShuffle ? 'üîÄ Karƒ±≈ütƒ±r (A√ßƒ±k)' : 'üîÄ Karƒ±≈ütƒ±r';
  
  if(isShuffle) {
    shuffleHistory = [currentIndex];
  } else {
    shuffleHistory = [];
  }
  
  infoLine.innerText = isShuffle ? 'Karƒ±≈ütƒ±rma A√ßƒ±k. Sƒ±ra Rastgele √áalƒ±nacak.' : 'Karƒ±≈ütƒ±rma Kapalƒ±.';
  saveState(); // YENƒ∞: Karƒ±≈ütƒ±rma modu deƒüi≈üince kaydet
});

/* ---------- UI Event bindings ---------- */
addBtn.addEventListener('click', addToQueue);
queueInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') addToQueue(); });

playBtn.addEventListener('click', togglePlay);
prevBtn.addEventListener('click', playPrev); 
nextBtn.addEventListener('click', ()=> playNext()); 
rewBtn.addEventListener('click', ()=> seekBy(-10));
fwdBtn.addEventListener('click', ()=> seekBy(10));

volUpBtn.addEventListener('click', volumeUp);
volDownBtn.addEventListener('click', volumeDown);

disk.addEventListener('dblclick', ()=> togglePlay());
progressArea.addEventListener('click', setProgress); 

/* ---------- Startup: empty UI - loadState() body etiketine ta≈üƒ±ndƒ± ---------- */

</script>
</body>
</html>
